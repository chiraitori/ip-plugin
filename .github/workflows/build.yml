name: Build & Release

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: gradle
    
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Build with Gradle
      run: ./gradlew shadowJar
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: IPBlock
        path: build/libs/*.jar
    
    # Upload to GitHub Release
    - name: Create Release & Upload
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: build/libs/*.jar
        generate_release_notes: true
    
    # Upload to Modrinth (skips if secrets not configured)
    - name: Upload to Modrinth
      if: startsWith(github.ref, 'refs/tags/')
      uses: Kir-Antipov/mc-publish@v3.3
      with:
        modrinth-id: ${{ secrets.MODRINTH_PROJECT_ID }}
        modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
        modrinth-featured: true
        
        files: build/libs/*.jar
        name: IPBlock ${{ github.ref_name }}
        version: ${{ github.ref_name }}
        version-type: release
        
        loaders: |
          paper
          purpur
          folia
        game-versions: |
          1.20
          1.20.1
          1.20.2
          1.20.3
          1.20.4
          1.21
          1.21.1
          1.21.2
          1.21.3
          1.21.4
        
        changelog: ${{ github.event.release.body }}
      continue-on-error: true
